{% extends "base.html" %}
{% block body %}
<div class="max-w-6xl mx-auto py-6 text-gray-100">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold">{{ title }}</h1>
    <a href="{{ url_for('compras_list') }}" class="px-3 py-2 rounded-xl bg-black/40 border border-zinc-800 text-sm hover:bg-black/55">Voltar</a>
  </div>

  <form method="post" class="rounded-2xl bg-black/40 border border-zinc-800 p-5 text-sm">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <div class="text-xs text-zinc-400 mb-1">Fornecedor</div>
        <input name="supplier" value="{{ row.supplier if row else '' }}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2" required>
      </div>
      <div>
        <div class="text-xs text-zinc-400 mb-1">Documento / NF</div>
        <input name="doc_number" value="{{ row.doc_number if row else '' }}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">
      </div>
      <div>
        <div class="text-xs text-zinc-400 mb-1">Status</div>
        <select name="status" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">
          {% set st = (row.status if row else 'PENDENTE') %}
          {% for s in ["PENDENTE","EFETIVADO","CANCELADO"] %}
            <option value="{{ s }}" {% if st==s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <div class="text-xs text-zinc-400 mb-1">Data</div>
        <input type="date" name="date" value="{{ row.date if row else '' }}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">
      </div>
      <div>
        <div class="text-xs text-zinc-400 mb-1">Vencimento</div>
        <input type="date" name="due_date" value="{{ row.due_date if row else '' }}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">
      </div>
      <div>
        <div class="text-xs text-zinc-400 mb-1">Pagamento</div>
        <select name="payment_method_id" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">
          <option value="">-</option>
          {% for m in methods %}
            <option value="{{ m.id }}" {% if row and row.payment_method_id==m.id %}selected{% endif %}>{{ m.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="md:col-span-3">
        <div class="text-xs text-zinc-400 mb-1">Observações</div>
        <textarea name="notes" rows="2" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2">{{ row.notes if row else '' }}</textarea>
      </div>
    </div>

    <div class="mt-6 flex items-center justify-between">
      <h2 class="text-sm font-semibold">Itens da compra</h2>
      <div class="flex gap-2">
        <a href="{{ url_for('estoque') }}" class="px-3 py-2 rounded-xl bg-black/30 border border-zinc-700 hover:bg-black/50 text-xs">Abrir Estoque</a>
        <button type="button" id="addRow" class="px-3 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-xs font-semibold">+ Linha</button>
      </div>
    </div>

    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm" id="itensTable">
        <thead>
          <tr class="text-left text-zinc-400">
            <th class="py-2">Item</th>
            <th class="w-28">Qtd</th>
            <th class="w-36">Custo unit.</th>
            <th class="w-36 text-right">Total</th>
            <th class="w-10"></th>
          </tr>
        </thead>
        <tbody>
          {% set rows = items if items else [None] %}
          {% for it in rows %}
          <tr class="border-t border-zinc-800">
            <td class="py-2">
              <select name="item_inv_{{ loop.index }}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs">
                <option value="">Selecione...</option>
                {% for p in inv %}
                  <option value="{{ p.id }}" {% if it and it.inventory_id==p.id %}selected{% endif %}>{{ p.name }} {% if p.sku %}({{ p.sku }}){% endif %}</option>
                {% endfor %}
              </select>
            </td>
            <td><input name="item_qty_{{ loop.index }}" value="{{ it.qty if it else 1 }}" type="number" step="0.01" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs"></td>
            <td><input name="item_cost_{{ loop.index }}" value="{{ it.unit_cost if it else '' }}" type="number" step="0.01" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs"></td>
            <td class="text-right text-zinc-200 font-semibold totalCell">-</td>
            <td class="text-right"><button type="button" class="removeRow px-2 py-1 rounded-lg bg-zinc-700/40 border border-zinc-600 hover:bg-zinc-700/60 text-xs">x</button></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-end">
      <button class="px-4 py-2 rounded-xl bg-red-500 hover:bg-red-600 text-sm font-semibold">Salvar compra</button>
    </div>
  </form>
</div>

<script>
(function(){
  const table = document.getElementById('itensTable').querySelector('tbody');
  const addBtn = document.getElementById('addRow');

  function recalcRow(tr){
    const qty = parseFloat(tr.querySelector('input[name^="item_qty_"]').value || "0");
    const cost = parseFloat(tr.querySelector('input[name^="item_cost_"]').value || "0");
    const total = qty * cost;
    tr.querySelector('.totalCell').textContent = isFinite(total) ? total.toFixed(2) : "-";
  }

  function bind(tr){
    tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', () => recalcRow(tr)));
    tr.querySelector('.removeRow').addEventListener('click', () => {
      if(table.querySelectorAll('tr').length > 1) tr.remove();
    });
    recalcRow(tr);
  }

  table.querySelectorAll('tr').forEach(bind);

  addBtn.addEventListener('click', () => {
    const n = table.querySelectorAll('tr').length + 1;
    const tr = document.createElement('tr');
    tr.className = 'border-t border-zinc-800';
    tr.innerHTML = `
      <td class="py-2">
        <select name="item_inv_${n}" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs">
          <option value="">Selecione...</option>
          {% for p in inv %}
            <option value="{{ p.id }}">{{ p.name }} {% if p.sku %}({{ p.sku }}){% endif %}</option>
          {% endfor %}
        </select>
      </td>
      <td><input name="item_qty_${n}" value="1" type="number" step="0.01" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs"></td>
      <td><input name="item_cost_${n}" value="" type="number" step="0.01" class="w-full rounded-xl bg-black/40 border border-zinc-700 px-3 py-2 text-xs"></td>
      <td class="text-right text-zinc-200 font-semibold totalCell">-</td>
      <td class="text-right"><button type="button" class="removeRow px-2 py-1 rounded-lg bg-zinc-700/40 border border-zinc-600 hover:bg-zinc-700/60 text-xs">x</button></td>
    `;
    table.appendChild(tr);
    bind(tr);
  });
})();
</script>
{% endblock %}
