{% extends "base.html" %}
{% block body %}
<div class="wm-print-only">
  <img src="/static/logo.png" alt="FCAR" style="width:420px;filter:drop-shadow(0 8px 30px rgba(0,0,0,.25));" />
</div>

<div class="flex items-center gap-3 mb-4">
  <img src="/static/logo.png" alt="FCAR Reparação Automotiva" style="height:64px;width:auto;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.25);" />
  <div>
    <div class="text-xl font-bold">FCAR Reparação Automotiva</div>
    <div class="muted text-sm">Ordem de Serviço</div>
  </div>
</div>

<div class="flex items-center justify-between mb-3">
  <h1 class="text-xl font-semibold headline">OS #{{ o['id'] }} — {{ o['client_name'] }}</h1>
  <div class="noprint flex items-center gap-2">
    <button id="btnQR" class="btn alt" type="button">QR</button>
    {% if username and o['fin_tx_id'] %}
      <a class="btn alt" href="{{ url_for('financeiro_ver', tx_id=o['fin_tx_id']) }}">Financeiro</a>
    {% endif %}
    {% if username %}
      <a class="btn" href="{{ url_for('os_edit', os_id=o['id']) }}">Editar</a>
      <form method="post" action="{{ url_for('os_delete', os_id=o['id']) }}" class="js-delete-form inline" data-osid="{{ o['id'] }}" data-msg="Excluir OS #{{ o['id'] }}?">
        <button class="btn danger">Excluir</button>
      </form>
    {% endif %}
    <button class="btn alt" onclick="window.print()">Imprimir</button>
    {% if username %}
      <a class="btn" href="{{ url_for('os_list') }}">Voltar</a>
    {% endif %}
  </div>
</div>

<div class="glass p-4">
  <div class="grid md:grid-cols-4 gap-2 text-sm">
    <div><span class="muted">Data:</span> {{ o['created_at'] }}</div>
    <div><span class="muted">Veículo:</span> {{ o['plate'] or '-' }} {{ o['model'] or '' }}</div>
    <div><span class="muted">Mecânico:</span> {{ o['mech'] or '-' }}</div>
    <div><span class="muted">Status:</span> {{ o['status'] }}</div>
    <div><span class="muted">Pagamento:</span> {{ o['pay_method'] or '-' }} / {{ o['pay_status'] or '-' }}</div>
  </div>
  <div class="mt-3"><span class="muted">Observações:</span> {{ o['notes'] or '-' }}</div>
</div>

<div class="glass p-4 mt-3">
  <h2 class="font-semibold mb-2">Resumo automático</h2>
  <div class="grid md:grid-cols-5 gap-2 text-sm">
    <div><span class="muted">Peças (saída):</span> {{ pecas_total|money }}</div>
    <div><span class="muted">Mão de obra:</span> {{ mao_obra|money }}</div>
    <div><span class="muted">Serviços extras:</span> {{ servicos_itens_total|money }}</div>
    <div><span class="muted">Total serviços (entrada):</span> {{ servicos_total|money }}</div>
    <div><span class="muted">Total geral (entrada):</span> <b>{{ total|money }}</b></div>
  </div>
  {% if username and o['fin_tx_id'] %}
    <div class="mt-2 text-sm muted">
      Dica: este resumo já está detalhado no Financeiro (botão “Financeiro” acima).
    </div>
  {% endif %}
</div>

<div class="glass p-4 mt-3">
  <h2 class="font-semibold mb-2">Detalhamento</h2>

  <div class="grid md:grid-cols-2 gap-3">
    <div>
      <div class="font-semibold mb-2">Peças utilizadas (saída do estoque)</div>
      <table class="text-sm">
        <thead><tr><th>Peça</th><th>Qtd</th><th>Unit</th><th>Total</th></tr></thead>
        <tbody>
          {% for it in pecas %}
          <tr>
            <td>{{ it['description'] }}</td>
            <td>{{ '%.2f'|format(it['qty']) }}</td>
            <td>{{ it['unit_price']|money }}</td>
            <td>{{ it['total']|money }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="muted">Nenhuma peça registrada.</td></tr>
          {% endfor %}
          <tr>
            <td colspan="3" class="text-right font-semibold">Subtotal peças</td>
            <td class="font-semibold">{{ pecas_total|money }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div>
      <div class="font-semibold mb-2">Serviços (entrada)</div>
      <table class="text-sm">
        <thead><tr><th>Serviço</th><th>Qtd</th><th>Unit</th><th>Total</th></tr></thead>
        <tbody>
          <tr>
            <td>Mão de obra</td>
            <td>1</td>
            <td>{{ mao_obra|money }}</td>
            <td>{{ mao_obra|money }}</td>
          </tr>
          {% for it in servicos_itens %}
          <tr>
            <td>{{ it['description'] }}</td>
            <td>{{ '%.2f'|format(it['qty']) }}</td>
            <td>{{ it['unit_price']|money }}</td>
            <td>{{ it['total']|money }}</td>
          </tr>
          {% endfor %}
          <tr>
            <td colspan="3" class="text-right font-semibold">Subtotal serviços</td>
            <td class="font-semibold">{{ servicos_total|money }}</td>
          </tr>
        </tbody>
      </table>
      {% if (mao_obra|float) == 0 and (servicos_itens|length) == 0 %}
        <div class="muted text-sm mt-2">Nenhum serviço registrado.</div>
      {% endif %}
    </div>
  </div>

  <div class="mt-3 text-right text-lg font-bold">
    Total geral: {{ total|money }}
  </div>
</div>

{% if auto_print %}
<script>
  // Abre diálogo de impressão automaticamente ao carregar
  window.addEventListener('load', function(){ setTimeout(()=>window.print(), 300); });
</script>
{% endif %}

<!-- Modal QR da OS -->
<div id="qrModal" class="fixed inset-0 z-50 hidden items-center justify-center noprint">
  <div class="absolute inset-0 bg-black/70"></div>
  <div class="relative glass p-5 w-[92%] max-w-md">
    <h3 class="text-lg font-semibold mb-2">QR da OS #{{ o['id'] }}</h3>
    <div class="flex items-center justify-center">
      <img src="{{ url_for('qr_os', os_id=o['id']) }}" alt="QR OS" class="bg-white p-3 rounded-xl" style="width:240px;height:240px;" />
    </div>
    <div class="mt-3 font-mono text-sm break-all">{{ url_for('os_view', os_id=o['id'], _external=True) }}</div>
    <div class="flex justify-end gap-2 mt-4">
      <button id="btnCloseQR" class="btn alt">Fechar</button>
      <a class="btn" target="_blank" href="{{ url_for('os_view', os_id=o['id']) }}?print=1">Imprimir</a>
    </div>
  </div>
</div>
<script>
  (function(){
    const m = document.getElementById('qrModal');
    const open = document.getElementById('btnQR');
    const close = document.getElementById('btnCloseQR');
    function show(){ m.classList.remove('hidden'); m.classList.add('flex'); }
    function hide(){ m.classList.add('hidden'); m.classList.remove('flex'); }
    open?.addEventListener('click', show);
    close?.addEventListener('click', hide);
    m?.addEventListener('click', (e)=>{ if(e.target===m) hide(); });
  })();
</script>

{% endblock %}
